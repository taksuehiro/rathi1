AI-Rathispherd 要件定義書（v1.1）

1. 目的

錫（Tin）について、指定期間の 取引発生・計上（デリバリー）・先物カーブ・評価（MTM）・月末/日次ポジション内訳 を可視化する。
初期フェーズは ダミーデータで UI/API/DB を成立させ、将来的に Bedrock（解説）/ OpenSearch（検索・RAG）/ Cognito（認証） を拡張導入する。

2. 前提・スコープ

2.1 基準日（As-of）
- 基準日：2026-07-05

2.2 対象期間・粒度
- 対象期間：2026-01-01 ～ 2026-07-05
- 粒度：
  - 2026-06-30 まで：月次（M）
  - 2026-07-01 ～ 2026-07-05：日次（D）

2.3 対象商品・通貨
- 対象：錫（Tin）
- 取引・評価通貨：USD
- 数量単位：metric ton（mt）（固定）

2.4 データの扱い（重要）
- 取引（Trade）と計上（Delivery/Booking）は 別テーブルで保持
- 月末/日次ポジションは本来「契約・計上・評価から算出」できるが、初期は 算出済みのスナップショットとして保存する
- プレミアム/ベーシスは初期は扱わない（テーブルは後で追加可能）

3. システム構成（AWS）

3.1 初期構成（MVP - Phase 1）
- フロント：Next.js（Amplify Hosting）
- API：API Gateway（HTTP API） + Lambda
- DB：RDS PostgreSQL 16（t4g.micro, 20GB gp3）
  - インスタンス：db.t4g.micro（2vCPU, 1GB RAM）
  - ストレージ：20GB gp3（3000 IOPS baseline）
  - 想定月額：約$17/月
- 接続：Lambda直接接続（connection pooling）
- シークレット：Secrets Manager
- ログ：CloudWatch
- 監視：CloudWatch Alarms（接続数、CPUクレジット、レイテンシ）

3.2 段階的エスカレーションパス
Phase 2（接続数問題発生時）：
- RDS Proxy 追加（$14/月追加 → 合計$31/月）

Phase 3（CPU/データ増加時）：
- RDS t4g.small へ昇格（$24/月） または
- Aurora PostgreSQL Serverless v2 へ移行（必要な場合のみ）

3.3 将来拡張（スロット確保）
- 検索/RAG：OpenSearch（もしくは Bedrock Knowledge Bases）
- 解説生成：Bedrock（集計結果 → 文章化）
- 認証認可：Cognito（初期はなし）

4. 画面要件（ログイン無し）

4.1 画面一覧（MVP）

Dashboard
- as_of日付選択（カレンダー）
- 粒度切替（M/D）
- KPI：Net Position、MTM、Loan Outstanding
- ポジション内訳（スタック棒）
- 先物カーブ（0〜6M）
- 推移（Net Position/MTM/Loan：期間内）

Positions（ポジション詳細）
- コンポーネント内訳テーブル（qty/amount）
- as_of切替

Trades（取引一覧）
- 期間、粒度、種別（instrument/tenor）でフィルタ
- テーブル表示

Deliveries（計上一覧）
- Trades同様

Curve & Valuation
- 先物カーブ（0〜6M）
- 評価スナップショット（ref tenor、MTM）

5. データ要件（DB設計：最小）

5.1 共通ルール
- period_type：'M'（月次） / 'D'（日次）
- period_date：
  - 日次：当日
  - 月次：月末日（例：2026-06-30）

5.2 テーブル一覧
- trades
- deliveries
- futures_curve
- valuations
- position_components（計算済みポジション内訳スナップショット）

6. テーブル定義（属性）

6.1 trades（取引発生）
目的：日次/月次の取引発生（フロー）

- trade_id uuid PK
- period_type char(1) NOT NULL（M/D）
- period_date date NOT NULL
- buy_sell char(1) NOT NULL（B/S）
- instrument_type text NOT NULL（例：PHYSICAL, FUTURES）
- tenor_months smallint NULL（先物のみ 0〜6）
- quantity_mt numeric(18,6) NOT NULL
- trade_price_usd numeric(18,6) NOT NULL
- trade_amount_usd numeric(18,2) NULL（任意）
- notes text NULL
- created_at timestamptz NOT NULL default now()

インデックス：
- (period_date, period_type)
- (instrument_type, tenor_months)

6.2 deliveries（計上/デリバリー）
目的：受渡・計上を日次/月次で保持（取引日とズレる前提）

- delivery_id uuid PK
- linked_trade_id uuid NULL（初期はNULLで可）
- period_type char(1) NOT NULL（M/D）
- period_date date NOT NULL
- delivered_quantity_mt numeric(18,6) NOT NULL
- booking_amount_usd numeric(18,2) NOT NULL
- status text NULL
- notes text NULL
- created_at timestamptz NOT NULL default now()

インデックス：
- (period_date, period_type)
- (linked_trade_id)

6.3 futures_curve（先物カーブ：0〜6M）
目的：as_of時点のカーブ（0〜6か月先まで）

- as_of_date date NOT NULL
- tenor_months smallint NOT NULL（0〜6）
- futures_price_usd numeric(18,6) NOT NULL
- price_source text NULL（例：LME）
- created_at timestamptz NOT NULL default now()

PK：(as_of_date, tenor_months)

6.4 valuations（評価）
目的：as_of時点の評価スナップショット（MVPは先物参照のみ）

- as_of_date date NOT NULL
- period_type char(1) NOT NULL（M/D）
- scope text NOT NULL default 'TOTAL'
- position_qty_mt numeric(18,6) NOT NULL（ネット数量）
- ref_tenor_months smallint NULL（評価参照のテナー）
- futures_price_usd numeric(18,6) NULL（参照価格を保存）
- published_premium_usd numeric(18,6) NULL（初期はNULL）
- physical_price_usd numeric(18,6) NULL（初期はNULL）
- mtm_value_usd numeric(18,2) NOT NULL
- notes text NULL
- created_at timestamptz NOT NULL default now()

PK：(as_of_date, scope)

6.5 position_components（計算済みポジション内訳）
目的：ダッシュボードのスタック棒・内訳表の正本

- as_of_date date NOT NULL
- period_type char(1) NOT NULL（M/D）
- scope text NOT NULL default 'TOTAL'
- component_code text NOT NULL
- qty_mt numeric(18,6) NULL（数量系）
- amount_usd numeric(18,2) NULL（金額系）
- notes text NULL
- created_at timestamptz NOT NULL default now()

PK：(as_of_date, scope, component_code)

component_code（MVP）：
数量（mt）
- INVENTORY_ON_HAND
- IN_TRANSIT
- OPEN_PURCHASE
- OPEN_SALES（売り契約は負数）
- FUTURES_LME_NET（ショートは負数）
- OTC_NET（初期は0固定可）

金額（USD）
- LOAN_OUTSTANDING_USD

整合性（推奨）：
- valuations.position_qty_mt ＝（position_components の数量系合計）

7. API要件（Lambda設計）

7.1 エンドポイント（MVP）

- GET /v1/dashboard?asOf=YYYY-MM-DD
  - Dashboard表示に必要な情報をまとめて返す（valuation + components + curve）

- GET /v1/series?metric=netPositionMt|mtmValueUsd|loanOutstandingUsd&from=&to=
  - 時系列（推移グラフ）用

- GET /v1/positions?asOf=YYYY-MM-DD
  - ポジション内訳（components）取得

- GET /v1/trades?from=&to=&periodType=&instrumentType=&tenorMonths=&limit=
  - 取引一覧

- GET /v1/deliveries?from=&to=&periodType=&limit=
  - 計上一覧

- GET /v1/curve?asOf=YYYY-MM-DD
  - 先物カーブ単体

- POST /v1/admin/seed（開発用、後で閉鎖）
  - ダミーデータ投入（reset-and-seed）

7.2 Lambdaの切り方（最小）
- lambda-api-read：GET系全て
- lambda-api-admin：seedのみ

7.3 共通仕様
- JSON key は camelCase
- エラー形式統一：
```json
  {"error":{"code":"BAD_REQUEST","message":"asOf is required"}}
```
- CORS：Amplifyドメイン（開発中は広めでも可）
- DB接続：Secrets Manager経由、connection pooling（Lambda側で実装）
  - 接続プール設定：
    - max: 1（Lambda1つにつき1接続）
    - min: 0（アイドル時は切断）
    - idleTimeoutMillis: 30000（30秒）
    - connectionTimeoutMillis: 5000（5秒）
  - statement_timeout: 5000ms（クエリタイムアウト）

7.4 DB接続実装パターン（重要）
```typescript
// lambda/db.ts
import { Pool } from 'pg';

let pool: Pool | null = null;

export const getPool = () => {
  if (!pool) {
    pool = new Pool({
      host: process.env.DB_HOST,
      port: 5432,
      database: process.env.DB_NAME,
      user: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      max: 1,
      min: 0,
      idleTimeoutMillis: 30000,
      connectionTimeoutMillis: 5000,
      statement_timeout: 5000,
    });
  }
  return pool;
};

export const query = async (text: string, params?: any[]) => {
  const pool = getPool();
  return pool.query(text, params);
};

// Lambda終了時のクリーンアップ
process.on('SIGTERM', async () => {
  if (pool) await pool.end();
});
```

8. ダミーデータ要件

- 月次：2026-01-31 / 02-28 / … / 06-30
- 日次：2026-07-01〜07-05

各 as_of に対して：
- futures_curve：tenor 0〜6 を必ず保持
- position_components：component_code 全種を必ず保持（OTCは0でも行は作る）
- valuations：scope=TOTAL を必ず保持

9. 非機能要件（MVP）

9.1 性能
- Dashboard API：p95 < 1s（ダミー規模前提）
- クエリ最適化：
  - Dashboard APIは1クエリで必要データを取得（N+1クエリ禁止）
  - UNION ALLでvaluation/components/curveをまとめて取得

9.2 可用性
- 開発中は最低限（CloudWatchログ）

9.3 セキュリティ
- MVPはログイン無し
- 後で Cognito 導入し Authorizer をAPI Gatewayに付与できる設計にする

9.4 監査/再現性（将来重要）
- 評価は ref_tenor_months と参照価格を保存（再現性担保）

9.5 監視（必須）
CloudWatch Alarmsで以下を監視：
- RDS接続数（threshold: 50）
- CPUクレジットバランス（threshold: 20）
- CPU使用率（threshold: 80%）
- 読み取りレイテンシ（threshold: 100ms）

監視用クエリ例：
```sql
-- 接続数確認
SELECT count(*) as active_connections
FROM pg_stat_activity
WHERE state = 'active';
```

10. 将来拡張（要件メモ）

10.1 プレミアム/ベーシス
- published_premiums テーブル追加
- valuation に basis gap 等を追加

10.2 Bedrock解説
- まずSQLで集計→LLMで文章化（数値をLLMに計算させない）
- POST /v1/explain を将来追加

10.3 OpenSearch
- 用語集・定義・運用メモを検索/RAG化

10.4 認証
- Cognito + ロール（viewer/admin）付与
- /v1/admin/seed は admin のみに限定

11. 受入条件（MVP Doneの定義）

以下が全て満たされること：

1. 指定期間（2026-01-01〜2026-07-05）で、月次/日次の切替が UI で成立する
2. Dashboardで以下が表示できる
   - Net Position（mt）, MTM（USD）, Loan（USD）
   - ポジション内訳（component別）
   - 先物カーブ（0〜6M）
   - 推移（期間）
3. trades/deliveries の一覧がフィルタ付きで参照できる
4. seed API でダミーデータを投入し直せる（開発中のみ）
5. CloudWatch監視が設定され、アラームが正常動作する

12. ローカル開発方針（出来るところまでローカル）

12.1 ローカル環境
- Next.js（ローカル起動）
- Lambdaはローカルで擬似サーバ（またはSAM）で実行
- DBはローカルPostgreSQL（Docker）で代替し、スキーマ互換で進める

Docker Compose例：
```yaml
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: rathi_tin
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: localpassword
    ports:
      - "5432:5432"
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
```

12.2 AWS環境
- DB：RDS PostgreSQL（t4g.micro）へ配置
- API：API Gateway + Lambda へ配置
- フロント：Amplify Hosting へ配置
- 接続：Secrets Manager 経由で DB接続

13. 開発スケジュール（推奨）

Week 1-2：
- ローカルPostgreSQL + スキーマ作成
- ダミーデータ生成スクリプト
- Next.js基本画面（データなし）

Week 3-4：
- Lambda（ローカル擬似サーバ）+ API実装
- フロント-API接続
- Dashboard完成

Week 5-6：
- AWS配置（RDS → API Gateway → Amplify）
- Secrets Manager統合
- CloudWatch監視設定
- MVP完成

その後：
- Bedrock解説機能
- OpenSearch統合
- Cognito認証

14. コスト試算

14.1 MVP（Phase 1）
- RDS t4g.micro: $12.41/月
- ストレージ 20GB gp3: $2.30/月
- バックアップ 20GB: $2.00/月
- Secrets Manager: $0.40/月
- Lambda: $0-1/月（無料枠内想定）
- API Gateway: $0-1/月（無料枠内想定）
- Amplify Hosting: $0-1/月（無料枠内想定）
- CloudWatch: $0-1/月（基本メトリクス）

**合計：約$17-20/月**

14.2 Phase 2（RDS Proxy追加時）
- 上記 + RDS Proxy: $14/月
- **合計：約$31-34/月**

14.3 比較参考
- Aurora Serverless v2（0.5ACU最小）: $43/月〜
- **年間節約額：約$312-828**

15. リスクと対策

15.1 コネクション枯渇リスク
- リスク：Lambda並列実行でDB接続数が詰まる
- 対策：
  - 接続数監視（threshold: 50）
  - 問題発生時はPhase 2へ移行（RDS Proxy追加）

15.2 CPUクレジット枯渇リスク
- リスク：t4gバースト型のため、負荷継続で性能劣化
- 対策：
  - CPUクレジット監視（threshold: 20）
  - クエリ最適化（1クエリで必要データ取得）
  - 問題発生時はt4g.smallへ昇格

15.3 データ増加時のスケーラビリティ
- リスク：データ量増加で性能劣化
- 対策：
  - 適切なインデックス設定
  - 必要に応じてAurora移行（pg_dump/restore）

---

変更履歴
- v1.0: 初版（Aurora Serverless v2推奨）
- v1.1: RDS t4g.micro + 段階的エスカレーション方針に変更、監視要件追加、コスト試算追加